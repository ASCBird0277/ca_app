ÃƒÂ¯Ã‚Â»Ã‚Â¿<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Control Center</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRocYXzBl9+dPy0VlZB6N" crossorigin="anonymous">
  <style>
    body {
      background: radial-gradient(circle at top, #0f172a 0%, #111827 45%, #020617 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem;
      color: #0f172a;
    }
    .admin-overlay {
      width: 100%;
      max-width: 1040px;
    }
    .admin-card {
      border-radius: 1.25rem;
      overflow: hidden;
      backdrop-filter: blur(18px);
    }
    .admin-card .card-header {
      background: linear-gradient(90deg, #1d4ed8, #7c3aed);
      color: #fff;
      padding: 1rem 1.5rem;
    }
    .admin-card .card-body {
      background: #f8fafc;
      padding: 1.75rem;
    }
    .btn-toggle-group .btn {
      min-width: 110px;
    }
    .btn-toggle-group .btn-check:checked + .btn {
      background-color: #1d4ed8;
      color: #fff;
    }
    .panel-section {
      display: none;
    }
    .panel-section.active {
      display: block;
    }
    .subtle-label {
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #64748b;
    }
    .list-group.suggestions {
      max-height: 220px;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.25);
      border-radius: 0.75rem;
      z-index: 20;
    }
    .list-group.suggestions .list-group-item {
      cursor: pointer;
    }
    .d-none-important {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="admin-overlay">
    <div class="card shadow-xl admin-card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <a class="navbar-brand text-white fw-semibold" href="{{ url_for('index') }}">CA Admin</a>
        <button id="adminLock" class="btn btn-outline-light btn-sm" type="button">Lock</button>
      </div>
      <div class="card-body">
        <div id="alertPlaceholder" class="mb-3"></div>

        <div class="btn-group w-100 mb-4" role="group" aria-label="Admin primary actions" id="primaryActionGroup">
          <input type="radio" class="btn-check" name="primaryAction" id="actionProperty" value="property" checked>
          <label class="btn btn-outline-primary" for="actionProperty">Property</label>
          <input type="radio" class="btn-check" name="primaryAction" id="actionEmployee" value="employee">
          <label class="btn btn-outline-primary" for="actionEmployee">Employee</label>
          <input type="radio" class="btn-check" name="primaryAction" id="actionTransfer" value="transfer">
          <label class="btn btn-outline-primary" for="actionTransfer">Transfer</label>
        </div>

        <section class="panel-section active" data-panel="property">
          <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
            <div class="subtle-label">Property Maintenance</div>
            <div class="btn-group btn-toggle-group" role="group" aria-label="Property mode">
              <input type="radio" class="btn-check" name="propertyMode" id="propertyModeAdd" value="add" checked>
              <label class="btn btn-outline-secondary" for="propertyModeAdd">Add</label>
              <input type="radio" class="btn-check" name="propertyMode" id="propertyModeEdit" value="edit">
              <label class="btn btn-outline-secondary" for="propertyModeEdit">Edit</label>
              <input type="radio" class="btn-check" name="propertyMode" id="propertyModeRemove" value="remove">
              <label class="btn btn-outline-secondary" for="propertyModeRemove">Remove</label>
            </div>
          </div>

          <form id="propertyAddForm" class="row g-3" novalidate>
            <div id="propertyEditControls" class="col-12 d-none">
              <label for="propertyEditSelect" class="form-label">Select Property</label>
              <select id="propertyEditSelect" class="form-select"></select>
            </div>
            <div class="col-md-8">
              <label for="propertyName" class="form-label">Name</label>
              <input type="text" class="form-control" id="propertyName" required>
            </div>
            <div class="col-md-4">
              <label for="propertyUnits" class="form-label">Units</label>
              <input type="number" class="form-control" id="propertyUnits" min="0">
            </div>
            <div class="col-md-12">
              <label for="propertyAddress" class="form-label">Address</label>
              <input type="text" class="form-control" id="propertyAddress">
            </div>
            <div class="col-md-5">
              <label for="propertyCity" class="form-label">City</label>
              <input type="text" class="form-control" id="propertyCity">
            </div>
            <div class="col-md-3">
              <label for="propertyState" class="form-label">State</label>
              <input type="text" class="form-control" id="propertyState">
            </div>
            <div class="col-md-4">
              <label for="propertyZip" class="form-label">Zip</label>
              <input type="text" class="form-control" id="propertyZip">
            </div>
            <div class="col-md-6">
              <label for="propertyLatitude" class="form-label">Latitude</label>
              <input type="number" step="0.000001" class="form-control" id="propertyLatitude">
            </div>
            <div class="col-md-6">
              <label for="propertyLongitude" class="form-label">Longitude</label>
              <input type="number" step="0.000001" class="form-control" id="propertyLongitude">
            </div>
            <div class="col-md-6">
              <label for="propertyRegionalManager" class="form-label">Regional Manager</label>
              <input type="text" class="form-control" id="propertyRegionalManager">
            </div>
            <div class="col-md-6">
              <label for="propertyRegionalMaintenance" class="form-label">Regional Maintenance</label>
              <input type="text" class="form-control" id="propertyRegionalMaintenance">
            </div>
            <div class="col-md-6">
              <label for="propertyPositions" class="form-label">Position(s)</label>
              <textarea class="form-control" id="propertyPositions" rows="2"></textarea>
            </div>
            <div class="col-md-6">
              <label for="propertyPays" class="form-label">Pay(s)</label>
              <textarea class="form-control" id="propertyPays" rows="2"></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">Property ID</label>
              <input type="text" class="form-control" id="propertyAssignedId" readonly>
              <div class="form-text">IDs reuse cleared rows when available; otherwise the next number is assigned.</div>
            </div>
            <div class="col-12 d-grid">
              <button type="submit" class="btn btn-primary">Save Property</button>
            </div>
          </form>

          <form id="propertyRemoveForm" class="row g-3 d-none" novalidate>
            <div class="col-12">
              <label for="propertyRemoveName" class="form-label">Property Name</label>
              <input type="text" class="form-control" id="propertyRemoveName" list="propertyRemoveOptions" required>
            </div>
            <div class="col-12 d-grid">
              <button type="submit" class="btn btn-danger">Remove Property</button>
            </div>
            <p class="text-muted small mb-0">Removing clears the row but leaves the PropertyID ready for reuse.</p>
            <datalist id="propertyRemoveOptions"></datalist>
          </form>
        </section>

        <section class="panel-section" data-panel="employee">
          <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
            <div class="subtle-label">Employee Maintenance</div>
            <div class="btn-group btn-toggle-group" role="group" aria-label="Employee mode">
              <input type="radio" class="btn-check" name="employeeMode" id="employeeModeAdd" value="add" checked>
              <label class="btn btn-outline-secondary" for="employeeModeAdd">Add</label>
              <input type="radio" class="btn-check" name="employeeMode" id="employeeModeEdit" value="edit">
              <label class="btn btn-outline-secondary" for="employeeModeEdit">Edit</label>
              <input type="radio" class="btn-check" name="employeeMode" id="employeeModeRemove" value="remove">
              <label class="btn btn-outline-secondary" for="employeeModeRemove">Remove</label>
            </div>
          </div>

          <form id="employeeAddForm" class="row g-3" novalidate>
            <div id="employeeEditControls" class="col-12 d-none">
              <label for="employeeEditSelect" class="form-label">Select Employee</label>
              <select id="employeeEditSelect" class="form-select"></select>
            </div>
            <div class="col-md-4">
              <label for="employeeFirstName" class="form-label">First Name</label>
              <input type="text" class="form-control" id="employeeFirstName">
            </div>
            <div class="col-md-4">
              <label for="employeeLastName" class="form-label">Last Name</label>
              <input type="text" class="form-control" id="employeeLastName">
            </div>
            <div class="col-md-4">
              <label for="employeeTitle" class="form-label">Title</label>
              <input type="text" class="form-control" id="employeeTitle">
            </div>
            <div class="col-md-6">
              <label for="employeeProperty" class="form-label">Property</label>
              <input type="text" class="form-control" id="employeeProperty">
            </div>
            <div class="col-md-3">
              <label for="employeeEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="employeeEmail">
            </div>
            <div class="col-md-3">
              <label for="employeePhone" class="form-label">Phone</label>
              <input type="text" class="form-control" id="employeePhone">
            </div>
            <div class="col-12">
              <label class="form-label">Employee ID</label>
              <input type="text" class="form-control" id="employeeAssignedId" readonly>
              <div class="form-text">IDs increment automatically (E001, E002, and so on).</div>
            </div>
            <div class="col-12 d-grid">
              <button type="submit" class="btn btn-primary">Save Employee</button>
            </div>
          </form>

          <form id="employeeRemoveForm" class="row g-3 d-none" novalidate>
            <div class="col-md-6">
              <label for="employeeRemoveId" class="form-label">Employee ID</label>
              <input type="text" class="form-control" id="employeeRemoveId" list="employeeRemoveOptions" required>
            </div>
            <div class="col-md-6">
              <label for="employeeRemoveDate" class="form-label">Termination Date</label>
              <input type="date" class="form-control" id="employeeRemoveDate">
            </div>
            <div class="col-12 d-grid">
              <button type="submit" class="btn btn-danger">Remove Employee</button>
            </div>
            <p class="text-muted small mb-0">Removed employees are appended to Terminated_Employees.xlsx with the termination date.</p>
            <datalist id="employeeRemoveOptions"></datalist>
          </form>
        </section>

        <section class="panel-section" data-panel="transfer">
          <div class="subtle-label mb-3">Transfer Employee</div>
          <form id="transferForm" class="row g-3" novalidate>
            <div class="col-12 position-relative">
              <label for="transferEmployeeSearch" class="form-label">Employee</label>
              <input type="text" class="form-control" id="transferEmployeeSearch" placeholder="Search by name or ID" autocomplete="off">
              <input type="hidden" id="transferEmployeeId">
              <div id="transferSelection" class="form-text text-primary"></div>
              <div id="transferSuggestions" class="list-group suggestions position-absolute top-100 start-0 w-100 d-none"></div>
            </div>
            <div class="col-md-6">
              <label for="transferProperty" class="form-label">Destination Property</label>
              <input type="text" class="form-control" id="transferProperty" required>
            </div>
            <div class="col-md-6">
              <label for="transferPosition" class="form-label">New Position</label>
              <input type="text" class="form-control" id="transferPosition" required>
            </div>
            <div class="col-md-6">
              <label for="transferDate" class="form-label">Effective Date</label>
              <input type="date" class="form-control" id="transferDate">
            </div>
            <div class="col-md-6">
              <label for="transferEnteredBy" class="form-label">Entered By</label>
              <input type="text" class="form-control" id="transferEnteredBy">
            </div>
            <div class="col-12">
              <label for="transferNotes" class="form-label">Notes</label>
              <textarea class="form-control" id="transferNotes" rows="2"></textarea>
            </div>
            <div class="col-12">
              <div id="transferConflict" class="alert alert-warning d-none"></div>
            </div>
            <div class="col-12 d-grid">
              <button type="submit" class="btn btn-primary">Submit Transfer</button>
            </div>
          </form>
        </section>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script>
    (() => {
      'use strict';

      const state = {
        secret: '',
        propertyMode: 'add',
        employeeMode: 'add',
        properties: [],
        propertyById: new Map(),
        propertyByName: new Map(),
        employees: [],
        employeeById: new Map(),
        employeeByName: new Map(),
        transferConfirm: null,
      };

      const alertPlaceholder = document.getElementById('alertPlaceholder');
      const actionGroup = document.getElementById('primaryActionGroup');
      const adminLockButton = document.getElementById('adminLock');

      const propertyAddForm = document.getElementById('propertyAddForm');
      const propertyRemoveForm = document.getElementById('propertyRemoveForm');
      const propertyModeRadios = document.querySelectorAll('input[name="propertyMode"]');
      const propertyAssignedIdInput = document.getElementById('propertyAssignedId');
      const propertySubmitButton = propertyAddForm.querySelector('button[type="submit"]');
      const propertyEditControls = document.getElementById('propertyEditControls');
      const propertyEditSelect = document.getElementById('propertyEditSelect');
      const propertyRemoveDatalist = document.getElementById('propertyRemoveOptions');

      const employeeAddForm = document.getElementById('employeeAddForm');
      const employeeRemoveForm = document.getElementById('employeeRemoveForm');
      const employeeModeRadios = document.querySelectorAll('input[name="employeeMode"]');
      const employeeAssignedIdInput = document.getElementById('employeeAssignedId');
      const employeeSubmitButton = employeeAddForm.querySelector('button[type="submit"]');
      const employeeEditControls = document.getElementById('employeeEditControls');
      const employeeEditSelect = document.getElementById('employeeEditSelect');
      const employeeRemoveDatalist = document.getElementById('employeeRemoveOptions');

      const transferForm = document.getElementById('transferForm');
      const transferSearchInput = document.getElementById('transferEmployeeSearch');
      const transferHiddenId = document.getElementById('transferEmployeeId');
      const transferSelection = document.getElementById('transferSelection');
      const transferSuggestions = document.getElementById('transferSuggestions');
      const transferConflictAlert = document.getElementById('transferConflict');

      document.addEventListener('DOMContentLoaded', initialize);

      adminLockButton.addEventListener('click', () => {
        window.localStorage.removeItem('adminSecret');
        state.secret = '';
        showAlert('Admin session locked. Reload the page to continue.', 'info');
        disableInterface(true);
      });

      actionGroup.addEventListener('change', (event) => {
        if (event.target && event.target.name === 'primaryAction') {
          setActivePanel(event.target.value);
        }
      });

      propertyModeRadios.forEach((radio) => {
        radio.addEventListener('change', () => setPropertyMode(radio.value));
      });
      employeeModeRadios.forEach((radio) => {
        radio.addEventListener('change', () => setEmployeeMode(radio.value));
      });

      propertyAddForm.addEventListener('submit', handlePropertySubmit);
      propertyRemoveForm.addEventListener('submit', handlePropertyRemoveSubmit);
      propertyEditSelect.addEventListener('change', onPropertyEditSelect);

      employeeAddForm.addEventListener('submit', handleEmployeeSubmit);
      employeeRemoveForm.addEventListener('submit', handleEmployeeRemoveSubmit);
      employeeEditSelect.addEventListener('change', onEmployeeEditSelect);

      transferForm.addEventListener('submit', handleTransferSubmit);
      transferSearchInput.addEventListener('input', handleEmployeeSearchInput);
      transferSearchInput.addEventListener('focus', () => {
        if (transferSuggestions.children.length) {
          transferSuggestions.classList.remove('d-none');
        }
      });
      document.addEventListener('click', (event) => {
        if (!transferForm.contains(event.target)) {
          transferSuggestions.classList.add('d-none');
        }
      });

      async function initialize() {
        disableInterface(true);
        const allowed = await ensureAccess();
        if (!allowed) {
          showAlert('Admin secret is required to proceed.', 'danger', 6000);
          return;
        }
        await refreshPropertyDirectory();
        await refreshEmployeeDirectory();
        setPropertyMode('add');
        setEmployeeMode('add');
        disableInterface(false);
        setActivePanel('property');
        showAlert('Admin access verified.', 'success', 3000);
      }

      function disableInterface(disabled) {
        [propertyAddForm, propertyRemoveForm, employeeAddForm, employeeRemoveForm, transferForm].forEach((form) => {
          Array.from(form.elements).forEach((element) => {
            element.disabled = disabled;
          });
        });
        actionGroup.querySelectorAll('input').forEach((input) => {
          input.disabled = disabled;
        });
        adminLockButton.disabled = disabled;
      }

      function setActivePanel(name) {
        document.querySelectorAll('.panel-section').forEach((panel) => {
          panel.classList.toggle('active', panel.dataset.panel === name);
        });
      }

      function setPropertyMode(mode) {
        state.propertyMode = mode;
        document.getElementById('propertyModeAdd').checked = mode === 'add';
        document.getElementById('propertyModeEdit').checked = mode === 'edit';
        document.getElementById('propertyModeRemove').checked = mode === 'remove';
        propertySubmitButton.textContent = mode === 'edit' ? 'Update Property' : 'Save Property';
        propertyEditControls.classList.toggle('d-none', mode !== 'edit');
        if (mode !== 'edit') {
          delete propertyAddForm.dataset.editingId;
          propertyAssignedIdInput.value = '';
          propertyAddForm.reset();
        } else {
          delete propertyAddForm.dataset.editingId;
          propertyAssignedIdInput.value = '';
          propertyAddForm.reset();
          propertyEditSelect.value = '';
        }
        propertyRemoveForm.classList.toggle('d-none', mode !== 'remove');
        propertyAddForm.classList.toggle('d-none', mode === 'remove');
      }

      function setEmployeeMode(mode) {
        state.employeeMode = mode;
        document.getElementById('employeeModeAdd').checked = mode === 'add';
        document.getElementById('employeeModeEdit').checked = mode === 'edit';
        document.getElementById('employeeModeRemove').checked = mode === 'remove';
        employeeSubmitButton.textContent = mode === 'edit' ? 'Update Employee' : 'Save Employee';
        employeeEditControls.classList.toggle('d-none', mode !== 'edit');
        if (mode !== 'edit') {
          delete employeeAddForm.dataset.editingId;
          employeeAssignedIdInput.value = '';
          employeeAddForm.reset();
        } else {
          delete employeeAddForm.dataset.editingId;
          employeeAssignedIdInput.value = '';
          employeeAddForm.reset();
          employeeEditSelect.value = '';
        }
        employeeRemoveForm.classList.toggle('d-none', mode !== 'remove');
        employeeAddForm.classList.toggle('d-none', mode === 'remove');
      }

      async function ensureAccess() {
        let attempts = 0;
        while (attempts < 3) {
          let secret = (window.localStorage.getItem('adminSecret') || '').trim();
          if (!secret) {
            secret = window.prompt('Enter the admin secret');
            if (!secret) {
              return false;
            }
            secret = secret.trim();
            window.localStorage.setItem('adminSecret', secret);
          }
          state.secret = secret;
          const ok = await verifySecret();
          if (ok) {
            return true;
          }
          attempts += 1;
          window.localStorage.removeItem('adminSecret');
          showAlert('Secret rejected, please try again.', 'danger');
        }
        return false;
      }

      async function verifySecret() {
        try {
          const response = await authorizedFetch('/api/admin/ping');
          if (!response.ok) {
            return false;
          }
          const data = await response.json();
          return Boolean(data && data.ok);
        } catch (error) {
          console.error('Verification failed', error);
          return false;
        }
      }

      async function refreshPropertyDirectory(selectedId = '') {
        try {
          const response = await authorizedFetch('/api/admin/properties');
          if (!response.ok) {
            throw await buildError(response);
          }
          const data = await response.json();
          const properties = Array.isArray(data.properties) ? data.properties : [];
          state.properties = properties;
          state.propertyById = new Map();
          state.propertyByName = new Map();
          properties.forEach((record) => {
            const id = (record.propertyId || '').trim();
            const name = (record.property || '').trim();
            if (id) {
              state.propertyById.set(canonicalize(id), record);
            }
            if (name) {
              state.propertyByName.set(canonicalize(name), record);
            }
          });
          renderPropertySelect(selectedId);
          renderPropertyRemovalOptions();
        } catch (error) {
          console.error('Property directory error', error);
          showAlert('Unable to load property directory.', 'danger');
        }
      }

      async function refreshEmployeeDirectory(selectedId = '') {
        try {
          const response = await authorizedFetch('/api/admin/employees');
          if (!response.ok) {
            throw await buildError(response);
          }
          const data = await response.json();
          const employees = Array.isArray(data.employees) ? data.employees : [];
          state.employees = employees;
          state.employeeById = new Map();
          state.employeeByName = new Map();
          employees.forEach((record) => {
            const id = (record.employeeId || '').trim();
            const name = (record.employeeName || '').trim();
            if (id) {
              state.employeeById.set(canonicalize(id), record);
            }
            if (name) {
              state.employeeByName.set(canonicalize(name), record);
            }
          });
          renderEmployeeSelect(selectedId);
          renderEmployeeRemovalOptions();
        } catch (error) {
          console.error('Employee directory error', error);
          showAlert('Unable to load employee directory.', 'danger');
        }
      }

      function renderPropertySelect(selectedId = '') {
        const select = propertyEditSelect;
        if (!select) {
          return;
        }
        const items = state.properties.slice().sort((a, b) => {
          return (a.property || '').localeCompare(b.property || '');
        });
        const options = ['<option value="">Select property...</option>'];
        items.forEach((item) => {
          const id = (item.propertyId || '').trim();
          const name = (item.property || '').trim() || 'Unnamed property';
          const label = id ? `${name} (${id})` : name;
          const value = id || name;
          options.push(`<option value="${escapeHtml(value)}">${escapeHtml(label)}</option>`);
        });
        select.innerHTML = options.join('');
        if (selectedId) {
          select.value = selectedId;
        }
      }

      function renderPropertyRemovalOptions() {
        if (!propertyRemoveDatalist) {
          return;
        }
        const options = state.properties
          .filter((item) => item.property)
          .sort((a, b) => (a.property || '').localeCompare(b.property || ''))
          .map((item) => `<option value="${escapeHtml(item.property)}">`);
        propertyRemoveDatalist.innerHTML = options.join('');
      }

      function renderEmployeeSelect(selectedId = '') {
        const select = employeeEditSelect;
        if (!select) {
          return;
        }
        const items = state.employees.slice().sort((a, b) => {
          return (a.employeeName || '').localeCompare(b.employeeName || '');
        });
        const options = ['<option value="">Select employee...</option>'];
        items.forEach((item) => {
          const id = (item.employeeId || '').trim();
          const name = (item.employeeName || '').trim() || 'Unnamed employee';
          const label = id ? `${name} (${id})` : name;
          const value = id || name;
          options.push(`<option value="${escapeHtml(value)}">${escapeHtml(label)}</option>`);
        });
        select.innerHTML = options.join('');
        if (selectedId) {
          select.value = selectedId;
        }
      }

      function renderEmployeeRemovalOptions() {
        if (!employeeRemoveDatalist) {
          return;
        }
        const options = state.employees
          .filter((item) => item.employeeId)
          .sort((a, b) => (a.employeeId || '').localeCompare(b.employeeId || ''))
          .map((item) => `<option value="${escapeHtml(item.employeeId)}">${escapeHtml(item.employeeName || '')}</option>`);
        employeeRemoveDatalist.innerHTML = options.join('');
      }

      async function handlePropertySubmit(event) {
        event.preventDefault();
        if (state.propertyMode === 'remove') {
          return;
        }
        const payload = collectPropertyPayload();
        if (!payload.property) {
          showAlert('Property name is required.', 'warning');
          return;
        }
        if (state.propertyMode === 'edit') {
          const editingId = propertyAddForm.dataset.editingId || '';
          if (!editingId) {
            showAlert('Select a property to edit.', 'warning');
            return;
          }
          payload.propertyId = editingId;
        }
        try {
          const response = await authorizedFetch('/api/admin/properties', {
            method: 'POST',
            body: JSON.stringify(payload),
          });
          if (!response.ok) {
            throw await buildError(response);
          }
          const data = await response.json();
          await refreshPropertyDirectory(data.propertyId || '');
          if (state.propertyMode === 'edit') {
            if (data.propertyId) {
              const record = getPropertyRecord(data.propertyId);
              if (record) {
                fillPropertyForm(record);
                propertyEditSelect.value = data.propertyId;
              }
            }
            showAlert('Property updated successfully.', 'success');
          } else {
            propertyAddForm.reset();
            propertyAssignedIdInput.value = data.propertyId || '';
            showAlert(`Property saved (ID: ${data.propertyId || 'N/A'}).`, 'success');
          }
        } catch (error) {
          showAlert(error.message || 'Unable to save property.', 'danger');
        }
      }

      async function handlePropertyRemoveSubmit(event) {
        event.preventDefault();
        const name = (document.getElementById('propertyRemoveName').value || '').trim();
        if (!name) {
          showAlert('Provide a property name to remove.', 'warning');
          return;
        }
        if (!window.confirm(`Clear property "${name}"?`)) {
          return;
        }
        try {
          const url = `/api/admin/properties?Name=${encodeURIComponent(name)}`;
          const response = await authorizedFetch(url, { method: 'DELETE' });
          if (!response.ok) {
            throw await buildError(response);
          }
          propertyRemoveForm.reset();
          await refreshPropertyDirectory();
          showAlert('Property cleared successfully.', 'success');
        } catch (error) {
          showAlert(error.message || 'Unable to clear property.', 'danger');
        }
      }

      function collectPropertyPayload() {
        const payload = {
          property: readInput('propertyName'),
          units: readNumber('propertyUnits'),
          address: readInput('propertyAddress'),
          city: readInput('propertyCity'),
          state: readInput('propertyState'),
          zip: readInput('propertyZip'),
          latitude: readNumber('propertyLatitude'),
          longitude: readNumber('propertyLongitude'),
          regionalManager: readInput('propertyRegionalManager'),
          regionalMaintenanceSupervisor: readInput('propertyRegionalMaintenance'),
          positions: readInput('propertyPositions'),
          pays: readInput('propertyPays'),
        };
        if (state.propertyMode === 'edit' && propertyAddForm.dataset.editingId) {
          payload.propertyId = propertyAddForm.dataset.editingId;
        }
        return payload;
      }

      function onPropertyEditSelect() {
        const reference = propertyEditSelect.value;
        if (!reference) {
          delete propertyAddForm.dataset.editingId;
          propertyAssignedIdInput.value = '';
          propertyAddForm.reset();
          return;
        }
        const record = getPropertyRecord(reference);
        if (!record) {
          showAlert('Unable to locate selected property.', 'danger');
          return;
        }
        fillPropertyForm(record);
      }

      function fillPropertyForm(record) {
        propertyAddForm.dataset.editingId = record.propertyId || '';
        setField('propertyName', record.property || '');
        setField('propertyUnits', record.units != null ? record.units : '');
        setField('propertyAddress', record.address || '');
        setField('propertyCity', record.city || '');
        setField('propertyState', record.state || '');
        setField('propertyZip', record.zip || '');
        setField('propertyLatitude', record.latitude != null ? record.latitude : '');
        setField('propertyLongitude', record.longitude != null ? record.longitude : '');
        const manager = resolveStaffName(record.regionalManager);
        const maintenance = resolveStaffName(record.regionalMaintenanceSupervisor);
        setField('propertyRegionalManager', manager);
        setField('propertyRegionalMaintenance', maintenance);
        setField('propertyPositions', record.positions || '');
        setField('propertyPays', record.pays || '');
        propertyAssignedIdInput.value = record.propertyId || '';
      }

      async function handleEmployeeSubmit(event) {
        event.preventDefault();
        if (state.employeeMode === 'remove') {
          return;
        }
        const payload = collectEmployeePayload();
        if (state.employeeMode === 'edit') {
          const editingId = employeeAddForm.dataset.editingId || '';
          if (!editingId) {
            showAlert('Select an employee to edit.', 'warning');
            return;
          }
          payload.employeeId = editingId;
        }
        try {
          const response = await authorizedFetch('/api/admin/employees', {
            method: 'POST',
            body: JSON.stringify(payload),
          });
          if (!response.ok) {
            throw await buildError(response);
          }
          const data = await response.json();
          await refreshEmployeeDirectory(data.employeeId || '');
          if (state.employeeMode === 'edit') {
            if (data.employeeId) {
              const record = getEmployeeRecord(data.employeeId);
              if (record) {
                fillEmployeeForm(record);
                employeeEditSelect.value = data.employeeId;
              }
            }
            showAlert('Employee updated successfully.', 'success');
          } else {
            employeeAddForm.reset();
            employeeAssignedIdInput.value = data.employeeId || '';
            showAlert(`Employee saved with ID ${data.employeeId}.`, 'success');
          }
        } catch (error) {
          showAlert(error.message || 'Unable to save employee.', 'danger');
        }
      }

      async function handleEmployeeRemoveSubmit(event) {
        event.preventDefault();
        const employeeId = readInput('employeeRemoveId');
        const terminationDate = readInput('employeeRemoveDate');
        if (!employeeId) {
          showAlert('Employee ID is required for removal.', 'warning');
          return;
        }
        if (!window.confirm(`Remove employee ${employeeId}?`)) {
          return;
        }
        try {
          let url = `/api/admin/employees?EmployeeID=${encodeURIComponent(employeeId)}`;
          if (terminationDate) {
            url += `&terminatedOn=${encodeURIComponent(terminationDate)}`;
          }
          const response = await authorizedFetch(url, { method: 'DELETE' });
          if (!response.ok) {
            throw await buildError(response);
          }
          employeeRemoveForm.reset();
          await refreshEmployeeDirectory();
          showAlert('Employee removed and logged.', 'success');
        } catch (error) {
          showAlert(error.message || 'Unable to remove employee.', 'danger');
        }
      }

      function collectEmployeePayload() {
        const firstName = readInput('employeeFirstName');
        const lastName = readInput('employeeLastName');
        const employeeName = [firstName, lastName].filter(Boolean).join(' ') || null;
        const payload = {
          firstName,
          lastName,
          employeeName,
          title: readInput('employeeTitle'),
          property: readInput('employeeProperty'),
          email: readInput('employeeEmail'),
          phone: readInput('employeePhone'),
        };
        if (state.employeeMode === 'edit' && employeeAddForm.dataset.editingId) {
          payload.employeeId = employeeAddForm.dataset.editingId;
        }
        return payload;
      }

      function onEmployeeEditSelect() {
        const reference = employeeEditSelect.value;
        if (!reference) {
          delete employeeAddForm.dataset.editingId;
          employeeAssignedIdInput.value = '';
          employeeAddForm.reset();
          return;
        }
        const record = getEmployeeRecord(reference);
        if (!record) {
          showAlert('Unable to locate selected employee.', 'danger');
          return;
        }
        fillEmployeeForm(record);
      }

      function fillEmployeeForm(record) {
        employeeAddForm.dataset.editingId = record.employeeId || '';
        setField('employeeFirstName', record.firstName || '');
        setField('employeeLastName', record.lastName || '');
        setField('employeeTitle', record.title || '');
        setField('employeeProperty', record.property || '');
        setField('employeeEmail', record.email || '');
        setField('employeePhone', record.phone || '');
        employeeAssignedIdInput.value = record.employeeId || '';
      }

      async function handleEmployeeSearchInput(event) {
        const query = event.target.value.trim();
        state.transferConfirm = null;
        transferHiddenId.value = '';
        transferSelection.textContent = '';
        transferConflictAlert.classList.add('d-none');
        if (query.length < 2) {
          transferSuggestions.classList.add('d-none');
          transferSuggestions.innerHTML = '';
          return;
        }
        try {
          const response = await authorizedFetch(`/api/admin/employees/search?q=${encodeURIComponent(query)}`);
          if (!response.ok) {
            throw await buildError(response);
          }
          const data = await response.json();
          const results = Array.isArray(data.results) ? data.results : [];
          if (!results.length) {
            transferSuggestions.classList.add('d-none');
            transferSuggestions.innerHTML = '';
            return;
          }
          transferSuggestions.innerHTML = results
            .map((result) => {
              const labelParts = [];
              if (result.employeeName) {
                labelParts.push(result.employeeName);
              }
              if (result.employeeId) {
                labelParts.push(`(${result.employeeId})`);
              }
              if (result.property) {
                labelParts.push(`- ${result.property}`);
              }
              const label = labelParts.join(' ');
              return `<button type="button" class="list-group-item list-group-item-action" data-employee='${JSON.stringify(result)}'>${escapeHtml(label)}</button>`;
            })
            .join('');
          transferSuggestions.classList.remove('d-none');
        } catch (error) {
          console.error('Search error', error);
        }
      }

      transferSuggestions.addEventListener('click', (event) => {
        if (!(event.target instanceof HTMLElement)) {
          return;
        }
        const payload = event.target.getAttribute('data-employee');
        if (!payload) {
          return;
        }
        try {
          const info = JSON.parse(payload);
          transferHiddenId.value = info.employeeId || '';
          const labelParts = [];
          if (info.employeeName) {
            labelParts.push(info.employeeName);
          }
          if (info.employeeId) {
            labelParts.push(`(${info.employeeId})`);
          }
          if (info.property) {
            labelParts.push(`- ${info.property}`);
          }
          transferSelection.textContent = labelParts.join(' ');
          transferSuggestions.classList.add('d-none');
          transferSuggestions.innerHTML = '';
        } catch (error) {
          console.error('Failed to parse employee suggestion', error);
        }
      });

      async function handleTransferSubmit(event) {
        event.preventDefault();
        const employeeId = transferHiddenId.value.trim();
        const employeeName = transferSearchInput.value.trim();
        const toProperty = readInput('transferProperty');
        const position = readInput('transferPosition');
        if (!employeeId && !employeeName) {
          showAlert('Select an employee for transfer.', 'warning');
          return;
        }
        if (!toProperty || !position) {
          showAlert('Destination property and position are required.', 'warning');
          return;
        }
        const payload = {
          employeeId: employeeId || null,
          employeeName: employeeName || null,
          toProperty,
          position,
          effectiveDate: readInput('transferDate'),
          enteredBy: readInput('transferEnteredBy'),
          notes: readInput('transferNotes'),
          confirmReplace: Boolean(state.transferConfirm),
        };
        try {
          const response = await authorizedFetch('/api/admin/transfers', {
            method: 'POST',
            body: JSON.stringify(payload),
          });
          if (response.status === 409) {
            const data = await response.json();
            const occupant = data.occupant || {};
            state.transferConfirm = occupant;
            transferConflictAlert.innerHTML = `<strong>${escapeHtml(occupant.employeeName || 'Position filled')}</strong> ${occupant.employeeId ? escapeHtml(`(Current ID: ${occupant.employeeId})`) : ''} Submit again to replace.`;
            transferConflictAlert.classList.remove('d-none');
            showAlert('Position is filled. Submit again to confirm replacement.', 'warning', 6000);
            return;
          }
          if (!response.ok) {
            throw await buildError(response);
          }
          await response.json();
          transferForm.reset();
          transferHiddenId.value = '';
          transferSelection.textContent = '';
          transferConflictAlert.classList.add('d-none');
          state.transferConfirm = null;
          showAlert('Transfer completed successfully.', 'success');
        } catch (error) {
          showAlert(error.message || 'Unable to process transfer.', 'danger');
        }
      }

      function readInput(id) {
        const element = document.getElementById(id);
        if (!element) {
          return null;
        }
        const value = element.value;
        if (value === undefined || value === null) {
          return null;
        }
        const trimmed = String(value).trim();
        return trimmed || null;
      }

      function readNumber(id) {
        const value = readInput(id);
        if (value === null) {
          return null;
        }
        const number = Number(value);
        return Number.isNaN(number) ? null : number;
      }

      function setField(id, value) {
        const element = document.getElementById(id);
        if (!element) {
          return;
        }
        if (value === null || value === undefined) {
          element.value = '';
        } else {
          element.value = value;
        }
      }

      function resolveStaffName(value) {
        if (!value) {
          return '';
        }
        if (typeof value === 'string') {
          return value;
        }
        if (typeof value === 'object') {
          return value.employeeName || value.name || '';
        }
        return String(value);
      }

      function canonicalize(value) {
        return String(value || '').toLowerCase().replace(/[^a-z0-9]/g, '');
      }

      function getPropertyRecord(reference) {
        const canonical = canonicalize(reference);
        return state.propertyById.get(canonical) || state.propertyByName.get(canonical) || null;
      }

      function getEmployeeRecord(reference) {
        const canonical = canonicalize(reference);
        return state.employeeById.get(canonical) || state.employeeByName.get(canonical) || null;
      }

      function showAlert(message, variant = 'info', timeout = 4000) {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `<div class="alert alert-${variant} alert-dismissible fade show" role="alert">${escapeHtml(message)}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>`;
        alertPlaceholder.append(wrapper);
        if (timeout > 0) {
          window.setTimeout(() => {
            const alert = bootstrap.Alert.getOrCreateInstance(wrapper.firstElementChild);
            alert.close();
          }, timeout);
        }
      }

      async function buildError(response) {
        try {
          const data = await response.json();
          const message = (data && (data.error || data.message)) || `Request failed with status ${response.status}`;
          return new Error(message);
        } catch (error) {
          return new Error(`Request failed with status ${response.status}`);
        }
      }

      async function authorizedFetch(path, options = {}) {
        if (!state.secret) {
          throw new Error('Missing admin secret');
        }
        const headers = new Headers(options.headers || {});
        headers.set('X-Admin-Secret', state.secret);
        const method = (options.method || 'GET').toUpperCase();
        if (method !== 'GET' && options.body && !headers.has('Content-Type')) {
          headers.set('Content-Type', 'application/json');
        }
        let url = path;
        url += (url.includes('?') ? '&' : '?') + `admin_secret=${encodeURIComponent(state.secret)}`;
        return fetch(url, { ...options, headers });
      }

      function escapeHtml(value) {
        return String(value || '').replace(/[&<>"']/g, (char) => {
          const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
          return map[char] || char;
        });
      }
    })();
  </script>
</body>
</html>
